<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AI File Search</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background: #1e1e1e;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }
    
    .app { display: flex; height: 100vh; }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      width: 200px;
      background: #2d2d2d;
      border-right: 1px solid #3d3d3d;
      padding: 40px 0 12px;
      flex-shrink: 0;
      overflow-y: auto;
    }
    
    .sidebar-section { margin-bottom: 16px; }
    
    .sidebar-title {
      font-size: 11px;
      color: #8e8e93;
      padding: 4px 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .tree-item {
      display: flex;
      align-items: center;
      padding: 5px 8px;
      margin: 1px 4px;
      cursor: pointer;
      font-size: 13px;
      color: #e5e5e7;
      border-radius: 5px;
    }
    
    .tree-item:hover { background: #3a3a3c; }
    .tree-item.active { background: #0a84ff; }
    
    .tree-expand {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #8e8e93;
      flex-shrink: 0;
    }
    
    .tree-icon {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      flex-shrink: 0;
    }
    
    .tree-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .tree-children { padding-left: 16px; }
    
    /* ãƒ¡ã‚¤ãƒ³ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .toolbar {
      height: 52px;
      background: linear-gradient(#3a3a3c, #323232);
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      align-items: center;
      padding: 0 16px;
      -webkit-app-region: drag;
      gap: 12px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
    }
    
    .nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: #4a4a4c;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .nav-btn:hover { background: #5a5a5c; }
    .nav-btn:disabled { opacity: 0.3; cursor: default; }
    .nav-btn svg { width: 14px; height: 14px; fill: #fff; }
    
    .breadcrumb {
      display: flex;
      align-items: center;
      flex: 1;
      font-size: 13px;
      overflow: hidden;
      -webkit-app-region: no-drag;
    }
    
    .breadcrumb-item {
      color: #8e8e93;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .breadcrumb-item:hover { color: #fff; }
    .breadcrumb-item.current { color: #fff; font-weight: 600; }
    .breadcrumb-sep { margin: 0 6px; color: #6e6e73; }
    
    .toolbar-stats {
      font-size: 11px;
      color: #8e8e93;
      -webkit-app-region: no-drag;
    }
    
    .file-header {
      display: grid;
      grid-template-columns: 1fr 80px 100px 120px;
      padding: 6px 16px;
      font-size: 11px;
      color: #8e8e93;
      background: #252525;
      border-bottom: 1px solid #3d3d3d;
    }
    
    .file-list {
      flex: 1;
      overflow-y: auto;
      background: #1e1e1e;
    }
    
    .file-item {
      display: grid;
      grid-template-columns: 1fr 80px 100px 120px;
      padding: 5px 16px;
      font-size: 13px;
      border-bottom: 1px solid #282828;
      cursor: default;
      align-items: center;
    }
    
    .file-item:hover { background: #2a2a2c; }
    .file-item.selected { background: #0a84ff; }
    
    .file-name {
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: hidden;
    }
    
    .file-name span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .item-icon {
      width: 20px;
      height: 22px;
      border-radius: 3px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: 700;
      color: #fff;
    }
    
    .item-icon.folder { background: #0a84ff; }
    .item-icon.pdf { background: #e74c3c; }
    .item-icon.docx, .item-icon.doc { background: #2980b9; }
    .item-icon.xlsx, .item-icon.xls, .item-icon.csv { background: #27ae60; }
    .item-icon.pptx, .item-icon.ppt { background: #d35400; }
    .item-icon.txt, .item-icon.md { background: #7f8c8d; }
    
    .file-meta { color: #8e8e93; font-size: 12px; }
    
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6e6e73;
      font-size: 14px;
    }
    
    /* ãƒãƒ£ãƒƒãƒˆ */
    .chat-panel {
      width: 400px;
      min-width: 300px;
      max-width: 800px;
      background: #252525;
      border-left: 1px solid #3d3d3d;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
    }

    .chat-panel.collapsed {
      width: 0;
      min-width: 0;
      border-left: none;
    }

    /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
    .resize-handle {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: ew-resize;
      background: transparent;
      z-index: 10;
    }

    .resize-handle:hover,
    .resize-handle.dragging {
      background: #0a84ff;
    }
    
    .chat-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: #3a3a3c;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag;
    }
    
    .chat-toggle:hover { background: #4a4a4c; }
    .chat-toggle svg { width: 18px; height: 18px; fill: #fff; }
    
    .chat-header {
      padding: 12px 16px;
      background: #2d2d2d;
      border-bottom: 1px solid #3d3d3d;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-header-left {
      display: flex;
      flex-direction: column;
    }
    
    .chat-title { font-size: 14px; font-weight: 600; }
    .chat-subtitle { font-size: 11px; color: #8e8e93; margin-top: 2px; }
    
    .new-chat-btn {
      background: #3a3a3c;
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .new-chat-btn:hover { background: #4a4a4c; }
    .new-chat-btn svg { width: 14px; height: 14px; fill: #fff; }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .message { margin-bottom: 12px; max-width: 95%; }
    
    .message-user {
      background: #0a84ff;
      padding: 10px 14px;
      border-radius: 18px 18px 4px 18px;
      font-size: 14px;
      margin-left: auto;
      width: fit-content;
      white-space: pre-wrap;
    }
    
    .message-ai {
      background: #3a3a3c;
      padding: 10px 14px;
      border-radius: 18px 18px 18px 4px;
      font-size: 14px;
    }
    
    .file-result {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    
    .file-result-name { font-weight: 600; font-size: 13px; }
    .file-result-path { font-size: 11px; color: #8e8e93; margin-top: 2px; word-break: break-all; }
    .file-result-summary { 
      font-size: 13px; 
      color: #e5e5e7; 
      margin-top: 10px; 
      line-height: 1.6; 
      background: #1e1e1e; 
      padding: 10px 12px; 
      border-radius: 8px;
      border-left: 3px solid #0a84ff;
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .file-actions button {
      background: #0a84ff;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .file-actions button:hover { background: #0070d4; }
    .file-actions button.danger { background: #e74c3c; }
    .file-actions button.danger:hover { background: #c0392b; }
    .file-actions button.success { background: #27ae60; }
    .file-actions button.success:hover { background: #1e8449; }

    .organize-suggestion {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 8px;
      border-left: 3px solid #f39c12;
    }

    .organize-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #3d3d3d;
    }

    .organize-item:last-child { border-bottom: none; }

    .organize-checkbox {
      margin-top: 2px;
      accent-color: #0a84ff;
    }

    .organize-info { flex: 1; }
    .organize-action { font-size: 12px; font-weight: 600; color: #f39c12; }
    .organize-target { font-size: 13px; color: #e5e5e7; margin-top: 2px; }
    .organize-reason { font-size: 11px; color: #8e8e93; margin-top: 4px; }
    
    .chat-input-area {
      padding: 12px;
      background: #2d2d2d;
      border-top: 1px solid #3d3d3d;
    }
    
    .chat-input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    
    .chat-input {
      flex: 1;
      background: #1e1e1e;
      border: 1px solid #3d3d3d;
      border-radius: 12px;
      padding: 10px 14px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 100px;
      line-height: 1.4;
    }
    
    .chat-input:focus { border-color: #0a84ff; }
    .chat-input::placeholder { color: #6e6e73; }
    
    .chat-send {
      background: #0a84ff;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .chat-send:hover { background: #0070d4; }
    .chat-send svg { fill: #fff; width: 16px; height: 16px; }
    
    .chat-hint { font-size: 10px; color: #6e6e73; margin-top: 6px; text-align: right; }
    
    .loading { display: flex; align-items: center; gap: 8px; }
    
    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #3d3d3d;
      border-top-color: #0a84ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #4a4a4c; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">ã‚ˆãä½¿ã†é …ç›®</div>
        <div id="quickAccess">
          <div class="tree-item" data-action="recent">
            <span class="tree-expand"></span>
            <svg class="tree-icon" viewBox="0 0 24 24" fill="#8e8e93"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
            <span class="tree-name">æœ€è¿‘ã®é …ç›®</span>
          </div>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">å ´æ‰€</div>
        <div id="locationTree"></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">ãƒ•ã‚©ãƒ«ãƒ€</div>
        <div id="folderTree"></div>
      </div>
    </div>
    
    <div class="main">
      <div class="toolbar" style="position: relative;">
        <div class="nav-buttons">
          <button class="nav-btn" id="navBack" disabled>
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </button>
          <button class="nav-btn" id="navForward" disabled>
            <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
          </button>
        </div>
        <div class="breadcrumb" id="breadcrumb">
          <span class="breadcrumb-item current">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—</span>
        </div>
        <div class="toolbar-stats" id="fileCount">0 é …ç›®</div>
        <button class="chat-toggle" id="chatToggle" title="AIãƒ‘ãƒãƒ«">
          <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
        </button>
      </div>
      
      <div class="file-header">
        <span>åå‰</span>
        <span>ã‚µã‚¤ã‚º</span>
        <span>ç¨®é¡</span>
        <span>æ›´æ–°æ—¥</span>
      </div>
      
      <div class="file-list" id="fileList">
        <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    
    <div class="chat-panel" id="chatPanel">
      <div class="resize-handle" id="resizeHandle"></div>
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-title">AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
          <div class="chat-subtitle">æ¤œç´¢ãƒ»æ•´ç†ãƒ»ãªã‚“ã§ã‚‚ç›¸è«‡</div>
        </div>
        <button class="new-chat-btn" id="newChatBtn">
          <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          æ–°è¦
        </button>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="message message-ai">
          ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚<br><br>
          <strong>æ¤œç´¢</strong><br>
          ã€Œè¦‹ç©æ›¸ã©ã“ï¼Ÿã€ã€Œå…ˆæœˆã®ãƒ¬ãƒãƒ¼ãƒˆæ¢ã—ã¦ã€<br><br>
          <strong>æ•´ç†</strong><br>
          ã€Œã“ã®ãƒ•ã‚©ãƒ«ãƒ€æ•´ç†ã—ã¦ã€â†’ ã©ã†æ•´ç†ã™ã‚‹ã‹èã„ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™<br><br>
          <strong>ç¢ºèª</strong><br>
          ã€ŒPDFã¯ä½•ä»¶ã‚ã‚‹ï¼Ÿã€ã€Œæœ€è¿‘ã®ãƒ•ã‚¡ã‚¤ãƒ«è¦‹ã›ã¦ã€<br><br>
          ãªã‚“ã§ã‚‚æ°—è»½ã«è©±ã—ã‹ã‘ã¦ãã ã•ã„ï¼
        </div>
      </div>
      
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chatInput" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢..." rows="1"></textarea>
          <button class="chat-send" id="chatSend">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
        </div>
        <div class="chat-hint">Enter é€ä¿¡ / Shift+Enter æ”¹è¡Œ / Cmd+N æ–°è¦</div>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    // ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
    const STORAGE_KEY = 'ai-file-search:chat-session';
    let chatSession = { messages: [] };

    function saveSession() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          messages: chatSession.messages,
          lastUpdated: Date.now()
        }));
      } catch (e) {
        console.log('Failed to save session:', e);
      }
    }

    function loadSession() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          chatSession.messages = parsed.messages || [];
          return chatSession.messages.length > 0;
        }
      } catch (e) {
        console.log('Failed to load session:', e);
      }
      return false;
    }

    function clearSession() {
      chatSession.messages = [];
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {}
    }

    function restoreMessages() {
      const container = $('chatMessages');
      container.innerHTML = '';
      chatSession.messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message message-${msg.type}`;
        div.innerHTML = msg.content;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    }

    // Finderã‚¹ã‚¿ã‚¤ãƒ«ã®æ—¥æœ¬èªãƒ•ã‚©ãƒ«ãƒ€åãƒãƒƒãƒ”ãƒ³ã‚°
    const FOLDER_NAME_MAP = {
      'Desktop': 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—',
      'Documents': 'æ›¸é¡',
      'Downloads': 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
      'Applications': 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³',
      'Movies': 'ãƒ ãƒ¼ãƒ“ãƒ¼',
      'Music': 'ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯',
      'Pictures': 'ãƒ”ã‚¯ãƒãƒ£',
      'Public': 'å…¬é–‹',
      'Library': 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒª'
    };

    const getLocalizedFolderName = (name) => FOLDER_NAME_MAP[name] || name;

    let folderTree = {};
    let navHistory = [];
    let navIndex = -1;
    let expandedFolders = new Set();
    
    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    const formatSize = b => !b ? '-' : b < 1024 ? b + ' B' : b < 1048576 ? Math.round(b/1024) + ' KB' : (b/1048576).toFixed(1) + ' MB';
    const formatDate = d => {
      if (!d) return '-';
      const dt = new Date(d), diff = Date.now() - dt;
      if (diff < 86400000) return 'ä»Šæ—¥';
      if (diff < 604800000) return Math.floor(diff/86400000) + 'æ—¥å‰';
      return dt.toLocaleDateString('ja-JP');
    };
    const fileType = ext => !ext ? 'ãƒ•ã‚©ãƒ«ãƒ€' : ({pdf:'PDF',docx:'Word',doc:'Word',xlsx:'Excel',xls:'Excel',pptx:'PPT',ppt:'PPT',txt:'TXT',md:'MD',csv:'CSV'})[ext] || ext.toUpperCase();
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ„ãƒªãƒ¼æç”»
    function renderTree(container, items, level = 0) {
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'tree-item';
        div.dataset.path = item.path;
        div.style.paddingLeft = (8 + level * 12) + 'px';
        
        const hasChildren = item.children && item.children.length > 0;
        const isExpanded = expandedFolders.has(item.path);
        
        div.innerHTML = `
          <span class="tree-expand">${hasChildren || item.children === null ? (isExpanded ? 'â–¼' : 'â–¶') : ''}</span>
          <svg class="tree-icon" viewBox="0 0 24 24" fill="#0a84ff"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>
          <span class="tree-name">${item.displayName || item.name}</span>
        `;
        
        container.appendChild(div);
        
        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚©ãƒ«ãƒ€é–‹ã
        div.onclick = (e) => {
          e.stopPropagation();
          navigateTo(item.path);
          document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
          div.classList.add('active');
        };
        
        // å±•é–‹ãƒˆã‚°ãƒ«
        div.querySelector('.tree-expand').onclick = async (e) => {
          e.stopPropagation();
          
          if (expandedFolders.has(item.path)) {
            expandedFolders.delete(item.path);
            // å­è¦ç´ å‰Šé™¤
            const childContainer = div.nextElementSibling;
            if (childContainer && childContainer.classList.contains('tree-children')) {
              childContainer.remove();
            }
            div.querySelector('.tree-expand').textContent = 'â–¶';
          } else {
            expandedFolders.add(item.path);
            div.querySelector('.tree-expand').textContent = 'â–¼';
            
            // å­ãƒ•ã‚©ãƒ«ãƒ€å–å¾—
            if (item.children === null) {
              item.children = await window.api.expandFolder(item.path);
            }
            
            if (item.children.length > 0) {
              const childContainer = document.createElement('div');
              childContainer.className = 'tree-children';
              div.after(childContainer);
              renderTree(childContainer, item.children, level + 1);
            }
          }
        };
        
        // æ—¢ã«å±•é–‹æ¸ˆã¿ãªã‚‰å­è¦ç´ ã‚‚æç”»
        if (isExpanded && item.children && item.children.length > 0) {
          const childContainer = document.createElement('div');
          childContainer.className = 'tree-children';
          div.after(childContainer);
          renderTree(childContainer, item.children, level + 1);
        }
      });
    }
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    async function navigateTo(path, addHistory = true) {
      if (addHistory) {
        navHistory = navHistory.slice(0, navIndex + 1);
        navHistory.push(path);
        navIndex = navHistory.length - 1;
      }
      updateNavButtons();

      // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’ä¿å­˜
      currentFolderPath = path;

      let contents, title;

      if (path === 'recent') {
        const files = await window.api.getRecentFiles();
        contents = { folders: [], files };
        title = 'æœ€è¿‘ã®é …ç›®';
        currentFolderPath = null;
      } else {
        contents = await window.api.getFolderContents(path);
        title = path.split('/').pop();
      }

      renderContents(contents);
      updateBreadcrumb(path);
    }
    
    function updateBreadcrumb(path) {
      if (path === 'recent') {
        $('breadcrumb').innerHTML = '<span class="breadcrumb-item current">æœ€è¿‘ã®é …ç›®</span>';
        return;
      }

      const home = path.split('/').slice(0, 3).join('/');
      const parts = path.replace(home, '').split('/').filter(Boolean);

      let html = '';
      let currentPath = home;

      parts.forEach((p, i) => {
        currentPath += '/' + p;
        const isLast = i === parts.length - 1;
        const displayName = getLocalizedFolderName(p);
        html += `<span class="breadcrumb-item ${isLast ? 'current' : ''}" data-path="${currentPath}">${displayName}</span>`;
        if (!isLast) html += '<span class="breadcrumb-sep">â€º</span>';
      });

      $('breadcrumb').innerHTML = html;

      $('breadcrumb').querySelectorAll('.breadcrumb-item').forEach(el => {
        el.onclick = () => navigateTo(el.dataset.path);
      });
    }
    
    function updateNavButtons() {
      $('navBack').disabled = navIndex <= 0;
      $('navForward').disabled = navIndex >= navHistory.length - 1;
    }
    
    $('navBack').onclick = () => { if (navIndex > 0) { navIndex--; navigateTo(navHistory[navIndex], false); } };
    $('navForward').onclick = () => { if (navIndex < navHistory.length - 1) { navIndex++; navigateTo(navHistory[navIndex], false); } };
    
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æç”»
    function renderContents(contents) {
      const { folders, files } = contents;
      const total = folders.length + files.length;
      
      $('fileCount').textContent = total + ' é …ç›®';
      
      if (total === 0) {
        $('fileList').innerHTML = '<div class="empty-state">ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã¯ç©ºã§ã™</div>';
        return;
      }
      
      let html = '';
      
      folders.forEach(f => {
        html += `
          <div class="file-item" data-type="folder" data-path="${f.path}">
            <div class="file-name">
              <div class="item-icon folder"><svg viewBox="0 0 24 24" fill="#fff" width="12"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div>
              <span>${f.displayName || f.name}</span>
            </div>
            <span class="file-meta">-</span>
            <span class="file-meta">ãƒ•ã‚©ãƒ«ãƒ€</span>
            <span class="file-meta">-</span>
          </div>
        `;
      });
      
      files.forEach(f => {
        html += `
          <div class="file-item" data-type="file" data-path="${f.path}">
            <div class="file-name">
              <div class="item-icon ${f.ext}">${(f.ext||'').toUpperCase().slice(0,3)}</div>
              <span>${f.name}</span>
            </div>
            <span class="file-meta">${formatSize(f.size)}</span>
            <span class="file-meta">${fileType(f.ext)}</span>
            <span class="file-meta">${formatDate(f.mtime)}</span>
          </div>
        `;
      });
      
      $('fileList').innerHTML = html;
      
      $('fileList').querySelectorAll('.file-item').forEach(el => {
        el.onclick = () => {
          $('fileList').querySelectorAll('.file-item').forEach(e => e.classList.remove('selected'));
          el.classList.add('selected');
        };
        el.ondblclick = () => {
          if (el.dataset.type === 'folder') navigateTo(el.dataset.path);
          else window.api.openFile(el.dataset.path);
        };
      });
    }
    
    // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹
    $('quickAccess').querySelector('[data-action="recent"]').onclick = () => {
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      navigateTo('recent');
    };
    
    // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹
    let currentFolderPath = null;

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const INITIAL_MESSAGE = `
      ã“ã‚“ã«ã¡ã¯ï¼ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚<br><br>
      <strong>æ¤œç´¢</strong><br>
      ã€Œè¦‹ç©æ›¸ã©ã“ï¼Ÿã€ã€Œå…ˆæœˆã®ãƒ¬ãƒãƒ¼ãƒˆæ¢ã—ã¦ã€<br><br>
      <strong>æ•´ç†</strong><br>
      ã€Œã“ã®ãƒ•ã‚©ãƒ«ãƒ€æ•´ç†ã—ã¦ã€â†’ ã©ã†æ•´ç†ã™ã‚‹ã‹èã„ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™<br><br>
      <strong>ç¢ºèª</strong><br>
      ã€ŒPDFã¯ä½•ä»¶ã‚ã‚‹ï¼Ÿã€ã€Œæœ€è¿‘ã®ãƒ•ã‚¡ã‚¤ãƒ«è¦‹ã›ã¦ã€<br><br>
      ãªã‚“ã§ã‚‚æ°—è»½ã«è©±ã—ã‹ã‘ã¦ãã ã•ã„ï¼
    `;

    // æ–°è¦ãƒãƒ£ãƒƒãƒˆ
    function newChat() {
      clearSession();
      $('chatMessages').innerHTML = `<div class="message message-ai">${INITIAL_MESSAGE}</div>`;
      $('chatInput').value = '';
      $('chatInput').focus();
    }
    
    $('newChatBtn').onclick = newChat;
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', e => {
      // Cmd+N or Ctrl+N ã§æ–°è¦ãƒãƒ£ãƒƒãƒˆ
      if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
        e.preventDefault();
        newChat();
      }
      // Cmd+K or Ctrl+K ã§æ¤œç´¢ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        $('chatInput').focus();
      }
    });
    
    // ãƒãƒ£ãƒƒãƒˆ
    function addMessage(html, type, skipSave = false) {
      const div = document.createElement('div');
      div.className = `message message-${type}`;
      div.innerHTML = html;
      $('chatMessages').appendChild(div);
      $('chatMessages').scrollTop = $('chatMessages').scrollHeight;

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä»¥å¤–ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
      if (!skipSave && !html.includes('class="loading"')) {
        chatSession.messages.push({
          type: type,
          content: html,
          timestamp: Date.now()
        });
        saveSession();
      }

      return div;
    }
    
    // ç¾åœ¨ã®æ•´ç†ææ¡ˆã‚’ä¿å­˜
    let currentOrganizeSuggestion = null;

    async function doSearch(query) {
      query = query.trim();
      if (!query) return;

      addMessage(query, 'user');

      const loading = addMessage('<div class="loading"><div class="spinner"></div>è€ƒãˆä¸­...</div>', 'ai');

      try {
        // ã¾ãšAIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è§£é‡ˆã•ã›ã‚‹
        const chatRes = await window.api.processChat(query, currentFolderPath);
        loading.remove();

        console.log('AI response:', chatRes);

        // AIã®åˆ¤æ–­ã«åŸºã¥ã„ã¦å‡¦ç†
        if (chatRes.action === 'collect_naming') {
          // ã¾ã¨ã‚ï¼šãƒ•ã‚©ãƒ«ãƒ€åå…¥åŠ›å¾…ã¡
          addMessage(chatRes.response, 'ai');
        } else if (chatRes.action === 'collect_confirm') {
          // ã¾ã¨ã‚ï¼šç¢ºèªå¾…ã¡
          renderCollectConfirm(chatRes);
        } else if (chatRes.action === 'organize_hearing') {
          // ãƒ’ã‚¢ãƒªãƒ³ã‚°é–‹å§‹
          addMessage(chatRes.response, 'ai');
        } else if (chatRes.action === 'organize_confirm') {
          // æ•´ç†ææ¡ˆã‚’è¡¨ç¤ºï¼ˆç¢ºèªå¾…ã¡ï¼‰
          renderOrganizeConfirm(chatRes);
        } else if (chatRes.action === 'organize_execute') {
          // æ•´ç†å®Ÿè¡Œ
          await executeOrganizeFromSession(chatRes);
        } else if (chatRes.action === 'organize') {
          // å¾“æ¥ã®æ•´ç†å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          await doOrganize();
        } else if (chatRes.action === 'search') {
          // æ¤œç´¢çµæœã‚’è¡¨ç¤ºï¼ˆæ—¢ã«å®Ÿè¡Œæ¸ˆã¿ï¼‰
          if (chatRes.searchResults && chatRes.searchResults.length > 0) {
            renderSearchResults(chatRes.response, chatRes.searchResults, chatRes.searchQuery);
          } else {
            addMessage(`${chatRes.response}\n\nè©²å½“ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`, 'ai');
          }
        } else if (chatRes.action === 'list_files') {
          // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
          renderFileList(chatRes.response, chatRes.files, chatRes.totalCount, chatRes.fileType);
        } else if (chatRes.action === 'error') {
          addMessage(`ã‚¨ãƒ©ãƒ¼: ${chatRes.response}`, 'ai');
        } else {
          // ãƒãƒ£ãƒƒãƒˆå¿œç­”
          addMessage(chatRes.response || 'ã™ã¿ã¾ã›ã‚“ã€ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'ai');
        }

      } catch (e) {
        loading.remove();
        addMessage(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'ai');
      }
    }

    // æ•´ç†å‡¦ç†
    async function doOrganize() {
      if (!currentFolderPath) {
        addMessage('æ•´ç†ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’å·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚', 'ai');
        return;
      }

      const loading = addMessage('<div class="loading"><div class="spinner"></div>ãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆ†æä¸­...</div>', 'ai');

      try {
        const res = await window.api.suggestOrganization(currentFolderPath);
        loading.remove();

        if (!res.success) {
          addMessage(`ã‚¨ãƒ©ãƒ¼: ${res.error}`, 'ai');
          return;
        }

        currentOrganizeSuggestion = res;

        let html = `<strong>ğŸ“ æ•´ç†ã®ææ¡ˆ</strong><br>${res.summary || 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†ã—ã¾ã™'}`;

        if (res.suggestions && res.suggestions.length > 0) {
          html += `<div class="organize-suggestion">`;
          res.suggestions.forEach((s, i) => {
            const actionLabel = {
              'move': 'ğŸ“¦ ç§»å‹•',
              'rename': 'âœï¸ åå‰å¤‰æ›´',
              'create_folder': 'ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ',
              'delete': 'ğŸ—‘ï¸ å‰Šé™¤'
            }[s.action] || s.action;

            html += `
              <div class="organize-item">
                <input type="checkbox" class="organize-checkbox" data-index="${i}" checked>
                <div class="organize-info">
                  <div class="organize-action">${actionLabel}</div>
                  <div class="organize-target">${s.target} â†’ ${s.destination || ''}</div>
                  <div class="organize-reason">${s.reason}</div>
                </div>
              </div>
            `;
          });
          html += `</div>`;
          html += `
            <div class="file-actions" style="margin-top: 12px;">
              <button class="success" onclick="executeOrganize()">âœ“ é¸æŠã—ãŸæ“ä½œã‚’å®Ÿè¡Œ</button>
              <button class="danger" onclick="cancelOrganize()">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          `;
        } else {
          html += '<br>ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã¯æ•´ç†ã™ã‚‹å¿…è¦ãŒãªã•ãã†ã§ã™ã€‚';
        }

        addMessage(html, 'ai');

      } catch (e) {
        loading.remove();
        addMessage(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'ai');
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆPDFä½•ä»¶ï¼Ÿãªã©ï¼‰
    function renderFileList(message, files, totalCount, fileType) {
      let html = `<strong>${message}</strong>`;

      if (files && files.length > 0) {
        // ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã«ã‚‚è¡¨ç¤º
        renderContents({ folders: [], files });
        $('breadcrumb').innerHTML = `<span class="breadcrumb-item current">${fileType.toUpperCase()}ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</span>`;
        $('fileCount').textContent = `${totalCount} ä»¶`;

        html += `<div style="margin-top: 8px; font-size: 12px; color: #8e8e93;">æœ€æ–°${files.length}ä»¶ã‚’å·¦ã®ã‚¨ãƒªã‚¢ã«è¡¨ç¤ºä¸­ï¼ˆå…¨${totalCount}ä»¶ï¼‰</div>`;

        // ãƒãƒ£ãƒƒãƒˆã«ã¯æœ€æ–°10ä»¶ã‚’è¡¨ç¤º
        files.slice(0, 10).forEach(f => {
          html += `
            <div class="file-result">
              <div class="file-result-name">ğŸ“„ ${f.name}</div>
              <div class="file-result-path">${f.path.split('/').slice(-2).join('/')}</div>
              <div class="file-actions">
                <button onclick="window.api.openFile('${f.path.replace(/'/g,"\\'")}')">é–‹ã</button>
                <button onclick="window.api.showInFinder('${f.path.replace(/'/g,"\\'")}')">Finder</button>
              </div>
            </div>
          `;
        });

        if (files.length > 10) {
          html += `<div style="margin-top: 8px; font-size: 12px; color: #8e8e93;">ğŸ“‹ ä»– ${files.length - 10}ä»¶ã¯å·¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã§ç¢ºèªã§ãã¾ã™</div>`;
        }
      } else {
        html += `<div style="margin-top: 8px;">è©²å½“ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      }

      addMessage(html, 'ai');
    }

    // æ¤œç´¢çµæœã‚’è¡¨ç¤º
    function renderSearchResults(message, results, query) {
      // ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã«è¡¨ç¤ºï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é›¢ã—ã¦displayNameè¿½åŠ ï¼‰
      const folders = results.filter(r => r.isFolder).map(f => ({
        ...f,
        displayName: f.name
      }));
      const files = results.filter(r => !r.isFolder);

      renderContents({ folders, files });
      $('breadcrumb').innerHTML = `<span class="breadcrumb-item current">æ¤œç´¢: "${query}"</span>`;

      let html = `<strong>${message}</strong>`;
      html += `<div style="margin-top: 8px; font-size: 12px; color: #8e8e93;">${results.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>`;

      results.forEach(r => {
        html += `
          <div class="file-result">
            <div class="file-result-name">${r.isFolder ? 'ğŸ“' : 'ğŸ“„'} ${r.name}</div>
            <div class="file-result-path">${r.path.split('/').slice(-2).join('/')}</div>
            ${r.summary ? `<div class="file-result-summary">${r.summary}</div>` : ''}
            <div class="file-actions">
              <button onclick="${r.isFolder ? `navigateTo('${r.path.replace(/'/g, "\\'")}')` : `window.api.openFile('${r.path.replace(/'/g, "\\'")}')`}">é–‹ã</button>
              <button onclick="window.api.showInFinder('${r.path.replace(/'/g,"\\'")}')">Finder</button>
            </div>
          </div>
        `;
      });

      addMessage(html, 'ai');
    }

    // å®Ÿéš›ã®æ¤œç´¢å‡¦ç†
    async function doActualSearch(query) {
      const loading = addMessage('<div class="loading"><div class="spinner"></div>æ¤œç´¢ã—ã¦è¦ç´„ä¸­...</div>', 'ai');

      try {
        const res = await window.api.search(query);
        loading.remove();

        if (res.error) {
          addMessage(`ã‚¨ãƒ©ãƒ¼: ${res.error}`, 'ai');
          return;
        }

        if (!res.results.length) {
          addMessage(`ã€Œ${query}ã€ã«é–¢é€£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`, 'ai');
          return;
        }

        renderContents({ folders: [], files: res.results });
        $('breadcrumb').innerHTML = `<span class="breadcrumb-item current">æ¤œç´¢: "${query}"</span>`;

        let html = `<strong>${res.results.length}ä»¶</strong>è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
        res.results.forEach(r => {
          html += `
            <div class="file-result">
              <div class="file-result-name">ğŸ“„ ${r.name}</div>
              <div class="file-result-path">${r.path}</div>
              <div class="file-result-summary">${r.summary || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'}</div>
              <div class="file-actions">
                <button onclick="window.api.openFile('${r.path.replace(/'/g,"\\'")}')">é–‹ã</button>
                <button onclick="window.api.showInFinder('${r.path.replace(/'/g,"\\'")}')">Finder</button>
              </div>
            </div>
          `;
        });
        addMessage(html, 'ai');

      } catch (e) {
        loading.remove();
        addMessage(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'ai');
      }
    }

    // æ•´ç†ã‚’å®Ÿè¡Œ
    async function executeOrganize() {
      if (!currentOrganizeSuggestion) return;

      const checkboxes = document.querySelectorAll('.organize-checkbox:checked');
      if (checkboxes.length === 0) {
        addMessage('å®Ÿè¡Œã™ã‚‹æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'ai');
        return;
      }

      const actions = [];
      checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.index);
        const suggestion = currentOrganizeSuggestion.suggestions[idx];
        if (suggestion) {
          // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è§£æ±º
          const file = currentOrganizeSuggestion.files.find(f =>
            f.name === suggestion.target || f.name.includes(suggestion.target)
          );

          actions.push({
            ...suggestion,
            basePath: currentOrganizeSuggestion.folderPath,
            sourcePath: file ? file.path : null
          });
        }
      });

      const loading = addMessage('<div class="loading"><div class="spinner"></div>æ•´ç†ã‚’å®Ÿè¡Œä¸­...</div>', 'ai');

      try {
        const res = await window.api.executeOrganization(actions);
        loading.remove();

        const successCount = res.results.filter(r => r.success).length;
        const failCount = res.results.filter(r => !r.success).length;

        let html = `<strong>âœ“ æ•´ç†å®Œäº†</strong><br>æˆåŠŸ: ${successCount}ä»¶`;
        if (failCount > 0) {
          html += ` / å¤±æ•—: ${failCount}ä»¶`;
        }

        addMessage(html, 'ai');

        // ãƒ•ã‚©ãƒ«ãƒ€ã‚’å†èª­ã¿è¾¼ã¿
        if (currentFolderPath) {
          navigateTo(currentFolderPath, false);
        }

        currentOrganizeSuggestion = null;

      } catch (e) {
        loading.remove();
        addMessage(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'ai');
      }
    }

    // æ•´ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelOrganize() {
      currentOrganizeSuggestion = null;
      addMessage('æ•´ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 'ai');
    }

    // ã¾ã¨ã‚ç¢ºèªã‚’è¡¨ç¤º
    function renderCollectConfirm(res) {
      let html = `<strong>ã¾ã¨ã‚ã®ç¢ºèª</strong><br>${res.response}`;

      html += `<div style="margin-top: 12px; padding: 12px; background: #2d2d2d; border-radius: 8px; border-left: 3px solid #27ae60;">
        <strong>ã“ã‚Œã§ã„ã„ã§ã™ã‹ï¼Ÿ</strong><br>
        <span style="color: #8e8e93; font-size: 12px;">ã€Œã„ã„ã‚ˆã€ã§å®Ÿè¡Œ / ã€Œé•ã†ã€ã§ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´ / ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§ä¸­æ­¢</span>
      </div>`;

      addMessage(html, 'ai');
    }

    // æ•´ç†ææ¡ˆã‚’ç¢ºèªè¡¨ç¤ºï¼ˆæ–°ãƒ•ãƒ­ãƒ¼ï¼‰
    function renderOrganizeConfirm(res) {
      let html = `<strong>ğŸ“ æ•´ç†ã®ææ¡ˆ</strong><br>${res.response}`;

      if (res.suggestions && res.suggestions.length > 0) {
        html += `<div class="organize-suggestion">`;
        res.suggestions.forEach((s, i) => {
          const actionLabel = {
            'move': 'ğŸ“¦ ç§»å‹•',
            'rename': 'âœï¸ åå‰å¤‰æ›´',
            'create_folder': 'ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ',
            'delete': 'ğŸ—‘ï¸ å‰Šé™¤'
          }[s.action] || s.action;

          html += `
            <div class="organize-item">
              <div class="organize-info">
                <div class="organize-action">${actionLabel}</div>
                <div class="organize-target">${s.target} â†’ ${s.destination || ''}</div>
                <div class="organize-reason">${s.reason}</div>
              </div>
            </div>
          `;
        });
        html += `</div>`;
        html += `<div style="margin-top: 12px; padding: 12px; background: #2d2d2d; border-radius: 8px; border-left: 3px solid #0a84ff;">
          <strong>ã“ã‚Œã§ç¢ºå®šã—ã¦ã„ã„ã§ã™ã‹ï¼Ÿ</strong><br>
          <span style="color: #8e8e93; font-size: 12px;">ã€Œã„ã„ã‚ˆã€ã§å®Ÿè¡Œ / ã€Œã‚„ã‚Šç›´ã—ã€ã§å†ææ¡ˆ / ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§ä¸­æ­¢</span>
        </div>`;
      } else {
        html += '<br>ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã¯æ•´ç†ã™ã‚‹å¿…è¦ãŒãªã•ãã†ã§ã™ã€‚';
      }

      addMessage(html, 'ai');
    }

    // æ•´ç†ã‚’å®Ÿè¡Œï¼ˆæ–°ãƒ•ãƒ­ãƒ¼ï¼‰
    async function executeOrganizeFromSession(res) {
      const loading = addMessage('<div class="loading"><div class="spinner"></div>æ•´ç†ã‚’å®Ÿè¡Œä¸­...</div>', 'ai');

      try {
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æº–å‚™
        const actions = [];
        if (res.suggestions) {
          res.suggestions.forEach(suggestion => {
            const file = res.files?.find(f =>
              f.name === suggestion.target || f.name.includes(suggestion.target)
            );

            actions.push({
              ...suggestion,
              basePath: res.folderPath,
              sourcePath: file ? file.path : null
            });
          });
        }

        const result = await window.api.executeOrganization(actions);
        loading.remove();

        const successCount = result.results.filter(r => r.success).length;
        const failCount = result.results.filter(r => !r.success).length;

        let html = `<strong>âœ“ æ•´ç†å®Œäº†</strong><br>æˆåŠŸ: ${successCount}ä»¶`;
        if (failCount > 0) {
          html += ` / å¤±æ•—: ${failCount}ä»¶`;
        }

        addMessage(html, 'ai');

        // ãƒ•ã‚©ãƒ«ãƒ€ã‚’å†èª­ã¿è¾¼ã¿
        if (currentFolderPath) {
          navigateTo(currentFolderPath, false);
        }

      } catch (e) {
        loading.remove();
        addMessage(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'ai');
      }
    }
    
    $('chatSend').onclick = () => {
      doSearch($('chatInput').value);
      $('chatInput').value = '';
      $('chatInput').style.height = 'auto';
    };
    
    $('chatInput').onkeydown = e => {
      // IMEå…¥åŠ›ä¸­ã¯ç„¡è¦–
      if (e.isComposing || e.keyCode === 229) return;
      
      // Enter ã§é€ä¿¡ï¼ˆShift+Enterã¯æ”¹è¡Œï¼‰
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doSearch($('chatInput').value);
        $('chatInput').value = '';
        $('chatInput').style.height = 'auto';
      }
    };
    
    $('chatInput').oninput = () => {
      $('chatInput').style.height = 'auto';
      $('chatInput').style.height = Math.min($('chatInput').scrollHeight, 100) + 'px';
    };
    
    // ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«é–‹é–‰
    $('chatToggle').onclick = () => {
      $('chatPanel').classList.toggle('collapsed');
    };
    
    // ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´é€šçŸ¥ã‚’å—ã‘å–ã£ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
    let refreshTimeout = null;
    window.api.onFileChanged((change) => {
      console.log('File changed:', change);

      // é€£ç¶šã—ãŸå¤‰æ›´ã‚’ã¾ã¨ã‚ã‚‹ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
      if (refreshTimeout) clearTimeout(refreshTimeout);
      refreshTimeout = setTimeout(() => {
        // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å†èª­ã¿è¾¼ã¿
        if (currentFolderPath && currentFolderPath !== 'recent') {
          // å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚©ãƒ«ãƒ€ã¨ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ãŒé–¢é€£ã—ã¦ã„ã‚‹ã‹ç¢ºèª
          const changedPath = change.dir + '/' + change.filename;
          if (changedPath.startsWith(currentFolderPath) || currentFolderPath.startsWith(change.dir)) {
            console.log('Refreshing current folder...');
            navigateTo(currentFolderPath, false);
          }
        }
      }, 300);
    });

    // ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã®ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½
    (function initResize() {
      const panel = $('chatPanel');
      const handle = $('resizeHandle');
      let isResizing = false;
      let startX, startWidth;

      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = panel.offsetWidth;
        handle.classList.add('dragging');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const diff = startX - e.clientX;
        const newWidth = Math.min(800, Math.max(300, startWidth + diff));
        panel.style.width = newWidth + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          handle.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    })();

    // åˆæœŸåŒ–
    async function init() {
      const data = await window.api.init();
      folderTree = data.folderTree;

      // å ´æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ›ãƒ¼ãƒ ãªã©ï¼‰
      if (data.locations && data.locations.length > 0) {
        const locationContainer = $('locationTree');
        renderTree(locationContainer, data.locations);
      }

      // ã‚ˆãä½¿ã†é …ç›®ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã€æ›¸é¡ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
      const treeContainer = $('folderTree');
      const favorites = data.favorites || Object.values(folderTree);
      renderTree(treeContainer, favorites);

      // æœ€åˆã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã
      if (favorites.length > 0) {
        navigateTo(favorites[0].path);
        treeContainer.querySelector('.tree-item')?.classList.add('active');
      }

      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å¾©å…ƒ
      if (loadSession()) {
        restoreMessages();
      }
    }

    init();
  </script>
</body>
</html>
