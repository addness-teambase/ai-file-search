<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AI File Search</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background: #1e1e1e;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }
    
    .app { display: flex; height: 100vh; }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      width: 200px;
      background: #2d2d2d;
      border-right: 1px solid #3d3d3d;
      padding: 40px 0 12px;
      flex-shrink: 0;
      overflow-y: auto;
    }
    
    .sidebar-section { margin-bottom: 16px; }
    
    .sidebar-title {
      font-size: 11px;
      color: #8e8e93;
      padding: 4px 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .tree-item {
      display: flex;
      align-items: center;
      padding: 5px 8px;
      margin: 1px 4px;
      cursor: pointer;
      font-size: 13px;
      color: #e5e5e7;
      border-radius: 5px;
    }
    
    .tree-item:hover { background: #3a3a3c; }
    .tree-item.active { background: #0a84ff; }
    
    .tree-expand {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #8e8e93;
      flex-shrink: 0;
    }
    
    .tree-icon {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      flex-shrink: 0;
    }
    
    .tree-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .tree-children { padding-left: 16px; }
    
    /* ãƒ¡ã‚¤ãƒ³ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .toolbar {
      height: 52px;
      background: linear-gradient(#3a3a3c, #323232);
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      align-items: center;
      padding: 0 16px;
      -webkit-app-region: drag;
      gap: 12px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
    }
    
    .nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: #4a4a4c;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .nav-btn:hover { background: #5a5a5c; }
    .nav-btn:disabled { opacity: 0.3; cursor: default; }
    .nav-btn svg { width: 14px; height: 14px; fill: #fff; }
    
    .breadcrumb {
      display: flex;
      align-items: center;
      flex: 1;
      font-size: 13px;
      overflow: hidden;
      -webkit-app-region: no-drag;
    }
    
    .breadcrumb-item {
      color: #8e8e93;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .breadcrumb-item:hover { color: #fff; }
    .breadcrumb-item.current { color: #fff; font-weight: 600; }
    .breadcrumb-sep { margin: 0 6px; color: #6e6e73; }
    
    .toolbar-stats {
      font-size: 11px;
      color: #8e8e93;
      -webkit-app-region: no-drag;
    }
    
    .file-header {
      display: grid;
      grid-template-columns: 1fr 80px 100px 120px;
      padding: 6px 16px;
      font-size: 11px;
      color: #8e8e93;
      background: #252525;
      border-bottom: 1px solid #3d3d3d;
    }
    
    .file-list {
      flex: 1;
      overflow-y: auto;
      background: #1e1e1e;
    }
    
    .file-item {
      display: grid;
      grid-template-columns: 1fr 80px 100px 120px;
      padding: 5px 16px;
      font-size: 13px;
      border-bottom: 1px solid #282828;
      cursor: default;
      align-items: center;
    }
    
    .file-item:hover { background: #2a2a2c; }
    .file-item.selected { background: #0a84ff; }
    
    .file-name {
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: hidden;
    }
    
    .file-name span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .item-icon {
      width: 20px;
      height: 22px;
      border-radius: 3px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: 700;
      color: #fff;
    }
    
    .item-icon.folder { background: #0a84ff; }
    .item-icon.pdf { background: #e74c3c; }
    .item-icon.docx, .item-icon.doc { background: #2980b9; }
    .item-icon.xlsx, .item-icon.xls, .item-icon.csv { background: #27ae60; }
    .item-icon.pptx, .item-icon.ppt { background: #d35400; }
    .item-icon.txt, .item-icon.md { background: #7f8c8d; }
    
    .file-meta { color: #8e8e93; font-size: 12px; }
    
    .empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6e6e73;
      font-size: 14px;
    }
    
    /* ãƒãƒ£ãƒƒãƒˆ */
    .chat-panel {
      width: 340px;
      background: #252525;
      border-left: 1px solid #3d3d3d;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.2s ease, opacity 0.2s ease;
      overflow: hidden;
    }
    
    .chat-panel.collapsed {
      width: 0;
      border-left: none;
    }
    
    .chat-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: #3a3a3c;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag;
    }
    
    .chat-toggle:hover { background: #4a4a4c; }
    .chat-toggle svg { width: 18px; height: 18px; fill: #fff; }
    
    .chat-header {
      padding: 12px 16px;
      background: #2d2d2d;
      border-bottom: 1px solid #3d3d3d;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-header-left {
      display: flex;
      flex-direction: column;
    }
    
    .chat-title { font-size: 14px; font-weight: 600; }
    .chat-subtitle { font-size: 11px; color: #8e8e93; margin-top: 2px; }
    
    .new-chat-btn {
      background: #3a3a3c;
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .new-chat-btn:hover { background: #4a4a4c; }
    .new-chat-btn svg { width: 14px; height: 14px; fill: #fff; }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .message { margin-bottom: 12px; max-width: 95%; }
    
    .message-user {
      background: #0a84ff;
      padding: 10px 14px;
      border-radius: 18px 18px 4px 18px;
      font-size: 14px;
      margin-left: auto;
      width: fit-content;
      white-space: pre-wrap;
    }
    
    .message-ai {
      background: #3a3a3c;
      padding: 10px 14px;
      border-radius: 18px 18px 18px 4px;
      font-size: 14px;
    }
    
    .file-result {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 8px;
    }
    
    .file-result-name { font-weight: 600; font-size: 13px; }
    .file-result-path { font-size: 11px; color: #8e8e93; margin-top: 2px; word-break: break-all; }
    .file-result-summary { 
      font-size: 13px; 
      color: #e5e5e7; 
      margin-top: 10px; 
      line-height: 1.6; 
      background: #1e1e1e; 
      padding: 10px 12px; 
      border-radius: 8px;
      border-left: 3px solid #0a84ff;
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .file-actions button {
      background: #0a84ff;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .file-actions button:hover { background: #0070d4; }
    
    .chat-input-area {
      padding: 12px;
      background: #2d2d2d;
      border-top: 1px solid #3d3d3d;
    }
    
    .chat-input-wrapper {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    
    .chat-input {
      flex: 1;
      background: #1e1e1e;
      border: 1px solid #3d3d3d;
      border-radius: 12px;
      padding: 10px 14px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 100px;
      line-height: 1.4;
    }
    
    .chat-input:focus { border-color: #0a84ff; }
    .chat-input::placeholder { color: #6e6e73; }
    
    .chat-send {
      background: #0a84ff;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .chat-send:hover { background: #0070d4; }
    .chat-send svg { fill: #fff; width: 16px; height: 16px; }
    
    .chat-hint { font-size: 10px; color: #6e6e73; margin-top: 6px; text-align: right; }
    
    .loading { display: flex; align-items: center; gap: 8px; }
    
    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #3d3d3d;
      border-top-color: #0a84ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #4a4a4c; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">ã‚ˆãä½¿ã†é …ç›®</div>
        <div id="quickAccess">
          <div class="tree-item" data-action="recent">
            <span class="tree-expand"></span>
            <svg class="tree-icon" viewBox="0 0 24 24" fill="#8e8e93"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
            <span class="tree-name">æœ€è¿‘ã®é …ç›®</span>
          </div>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">å ´æ‰€</div>
        <div id="folderTree"></div>
      </div>
    </div>
    
    <div class="main">
      <div class="toolbar" style="position: relative;">
        <div class="nav-buttons">
          <button class="nav-btn" id="navBack" disabled>
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </button>
          <button class="nav-btn" id="navForward" disabled>
            <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
          </button>
        </div>
        <div class="breadcrumb" id="breadcrumb">
          <span class="breadcrumb-item current">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—</span>
        </div>
        <div class="toolbar-stats" id="fileCount">0 é …ç›®</div>
        <button class="chat-toggle" id="chatToggle" title="AIãƒ‘ãƒãƒ«">
          <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
        </button>
      </div>
      
      <div class="file-header">
        <span>åå‰</span>
        <span>ã‚µã‚¤ã‚º</span>
        <span>ç¨®é¡</span>
        <span>æ›´æ–°æ—¥</span>
      </div>
      
      <div class="file-list" id="fileList">
        <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    
    <div class="chat-panel" id="chatPanel">
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="chat-title">AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
          <div class="chat-subtitle">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è©±ã—è¨€è‘‰ã§æ¤œç´¢</div>
        </div>
        <button class="new-chat-btn" id="newChatBtn">
          <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          æ–°è¦
        </button>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="message message-ai">
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚ä¾‹: ã€Œè¦‹ç©æ›¸ã©ã“ï¼Ÿã€ã€Œå…ˆæœˆã®ãƒ¬ãƒãƒ¼ãƒˆã€
        </div>
      </div>
      
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chatInput" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢..." rows="1"></textarea>
          <button class="chat-send" id="chatSend">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
        </div>
        <div class="chat-hint">Enter é€ä¿¡ / Shift+Enter æ”¹è¡Œ / Cmd+N æ–°è¦</div>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    
    let folderTree = {};
    let navHistory = [];
    let navIndex = -1;
    let expandedFolders = new Set();
    
    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    const formatSize = b => !b ? '-' : b < 1024 ? b + ' B' : b < 1048576 ? Math.round(b/1024) + ' KB' : (b/1048576).toFixed(1) + ' MB';
    const formatDate = d => {
      if (!d) return '-';
      const dt = new Date(d), diff = Date.now() - dt;
      if (diff < 86400000) return 'ä»Šæ—¥';
      if (diff < 604800000) return Math.floor(diff/86400000) + 'æ—¥å‰';
      return dt.toLocaleDateString('ja-JP');
    };
    const fileType = ext => !ext ? 'ãƒ•ã‚©ãƒ«ãƒ€' : ({pdf:'PDF',docx:'Word',doc:'Word',xlsx:'Excel',xls:'Excel',pptx:'PPT',ppt:'PPT',txt:'TXT',md:'MD',csv:'CSV'})[ext] || ext.toUpperCase();
    
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ„ãƒªãƒ¼æç”»
    function renderTree(container, items, level = 0) {
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'tree-item';
        div.dataset.path = item.path;
        div.style.paddingLeft = (8 + level * 12) + 'px';
        
        const hasChildren = item.children && item.children.length > 0;
        const isExpanded = expandedFolders.has(item.path);
        
        div.innerHTML = `
          <span class="tree-expand">${hasChildren || item.children === null ? (isExpanded ? 'â–¼' : 'â–¶') : ''}</span>
          <svg class="tree-icon" viewBox="0 0 24 24" fill="#0a84ff"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>
          <span class="tree-name">${item.name}</span>
        `;
        
        container.appendChild(div);
        
        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚©ãƒ«ãƒ€é–‹ã
        div.onclick = (e) => {
          e.stopPropagation();
          navigateTo(item.path);
          document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
          div.classList.add('active');
        };
        
        // å±•é–‹ãƒˆã‚°ãƒ«
        div.querySelector('.tree-expand').onclick = async (e) => {
          e.stopPropagation();
          
          if (expandedFolders.has(item.path)) {
            expandedFolders.delete(item.path);
            // å­è¦ç´ å‰Šé™¤
            const childContainer = div.nextElementSibling;
            if (childContainer && childContainer.classList.contains('tree-children')) {
              childContainer.remove();
            }
            div.querySelector('.tree-expand').textContent = 'â–¶';
          } else {
            expandedFolders.add(item.path);
            div.querySelector('.tree-expand').textContent = 'â–¼';
            
            // å­ãƒ•ã‚©ãƒ«ãƒ€å–å¾—
            if (item.children === null) {
              item.children = await window.api.expandFolder(item.path);
            }
            
            if (item.children.length > 0) {
              const childContainer = document.createElement('div');
              childContainer.className = 'tree-children';
              div.after(childContainer);
              renderTree(childContainer, item.children, level + 1);
            }
          }
        };
        
        // æ—¢ã«å±•é–‹æ¸ˆã¿ãªã‚‰å­è¦ç´ ã‚‚æç”»
        if (isExpanded && item.children && item.children.length > 0) {
          const childContainer = document.createElement('div');
          childContainer.className = 'tree-children';
          div.after(childContainer);
          renderTree(childContainer, item.children, level + 1);
        }
      });
    }
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    async function navigateTo(path, addHistory = true) {
      if (addHistory) {
        navHistory = navHistory.slice(0, navIndex + 1);
        navHistory.push(path);
        navIndex = navHistory.length - 1;
      }
      updateNavButtons();
      
      let contents, title;
      
      if (path === 'recent') {
        const files = await window.api.getRecentFiles();
        contents = { folders: [], files };
        title = 'æœ€è¿‘ã®é …ç›®';
      } else {
        contents = await window.api.getFolderContents(path);
        title = path.split('/').pop();
      }
      
      renderContents(contents);
      updateBreadcrumb(path);
    }
    
    function updateBreadcrumb(path) {
      if (path === 'recent') {
        $('breadcrumb').innerHTML = '<span class="breadcrumb-item current">æœ€è¿‘ã®é …ç›®</span>';
        return;
      }
      
      const home = path.split('/').slice(0, 3).join('/');
      const parts = path.replace(home, '').split('/').filter(Boolean);
      
      let html = '';
      let currentPath = home;
      
      parts.forEach((p, i) => {
        currentPath += '/' + p;
        const isLast = i === parts.length - 1;
        html += `<span class="breadcrumb-item ${isLast ? 'current' : ''}" data-path="${currentPath}">${p}</span>`;
        if (!isLast) html += '<span class="breadcrumb-sep">â€º</span>';
      });
      
      $('breadcrumb').innerHTML = html;
      
      $('breadcrumb').querySelectorAll('.breadcrumb-item').forEach(el => {
        el.onclick = () => navigateTo(el.dataset.path);
      });
    }
    
    function updateNavButtons() {
      $('navBack').disabled = navIndex <= 0;
      $('navForward').disabled = navIndex >= navHistory.length - 1;
    }
    
    $('navBack').onclick = () => { if (navIndex > 0) { navIndex--; navigateTo(navHistory[navIndex], false); } };
    $('navForward').onclick = () => { if (navIndex < navHistory.length - 1) { navIndex++; navigateTo(navHistory[navIndex], false); } };
    
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æç”»
    function renderContents(contents) {
      const { folders, files } = contents;
      const total = folders.length + files.length;
      
      $('fileCount').textContent = total + ' é …ç›®';
      
      if (total === 0) {
        $('fileList').innerHTML = '<div class="empty-state">ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã¯ç©ºã§ã™</div>';
        return;
      }
      
      let html = '';
      
      folders.forEach(f => {
        html += `
          <div class="file-item" data-type="folder" data-path="${f.path}">
            <div class="file-name">
              <div class="item-icon folder"><svg viewBox="0 0 24 24" fill="#fff" width="12"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div>
              <span>${f.name}</span>
            </div>
            <span class="file-meta">-</span>
            <span class="file-meta">ãƒ•ã‚©ãƒ«ãƒ€</span>
            <span class="file-meta">-</span>
          </div>
        `;
      });
      
      files.forEach(f => {
        html += `
          <div class="file-item" data-type="file" data-path="${f.path}">
            <div class="file-name">
              <div class="item-icon ${f.ext}">${(f.ext||'').toUpperCase().slice(0,3)}</div>
              <span>${f.name}</span>
            </div>
            <span class="file-meta">${formatSize(f.size)}</span>
            <span class="file-meta">${fileType(f.ext)}</span>
            <span class="file-meta">${formatDate(f.mtime)}</span>
          </div>
        `;
      });
      
      $('fileList').innerHTML = html;
      
      $('fileList').querySelectorAll('.file-item').forEach(el => {
        el.onclick = () => {
          $('fileList').querySelectorAll('.file-item').forEach(e => e.classList.remove('selected'));
          el.classList.add('selected');
        };
        el.ondblclick = () => {
          if (el.dataset.type === 'folder') navigateTo(el.dataset.path);
          else window.api.openFile(el.dataset.path);
        };
      });
    }
    
    // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹
    $('quickAccess').querySelector('[data-action="recent"]').onclick = () => {
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      navigateTo('recent');
    };
    
    // æ–°è¦ãƒãƒ£ãƒƒãƒˆ
    function newChat() {
      $('chatMessages').innerHTML = `
        <div class="message message-ai">
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚ä¾‹: ã€Œè¦‹ç©æ›¸ã©ã“ï¼Ÿã€ã€Œå…ˆæœˆã®ãƒ¬ãƒãƒ¼ãƒˆã€
        </div>
      `;
      $('chatInput').value = '';
      $('chatInput').focus();
    }
    
    $('newChatBtn').onclick = newChat;
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', e => {
      // Cmd+N or Ctrl+N ã§æ–°è¦ãƒãƒ£ãƒƒãƒˆ
      if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
        e.preventDefault();
        newChat();
      }
      // Cmd+K or Ctrl+K ã§æ¤œç´¢ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        $('chatInput').focus();
      }
    });
    
    // ãƒãƒ£ãƒƒãƒˆ
    function addMessage(html, type) {
      const div = document.createElement('div');
      div.className = `message message-${type}`;
      div.innerHTML = html;
      $('chatMessages').appendChild(div);
      $('chatMessages').scrollTop = $('chatMessages').scrollHeight;
      return div;
    }
    
    async function doSearch(query) {
      query = query.trim();
      if (!query) return;
      
      addMessage(query, 'user');
      const loading = addMessage('<div class="loading"><div class="spinner"></div>æ¤œç´¢ã—ã¦è¦ç´„ä¸­...</div>', 'ai');
      
      try {
        const res = await window.api.search(query);
        loading.remove();
        
        if (res.error) {
          addMessage(`ã‚¨ãƒ©ãƒ¼: ${res.error}`, 'ai');
          return;
        }
        
        if (!res.results.length) {
          addMessage('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'ai');
          return;
        }
        
        renderContents({ folders: [], files: res.results });
        $('breadcrumb').innerHTML = `<span class="breadcrumb-item current">æ¤œç´¢: "${query}"</span>`;
        
        let html = `<strong>${res.results.length}ä»¶</strong>è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
        res.results.forEach(r => {
          html += `
            <div class="file-result">
              <div class="file-result-name">ğŸ“„ ${r.name}</div>
              <div class="file-result-path">${r.path}</div>
              <div class="file-result-summary">${r.summary || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'}</div>
              <div class="file-actions">
                <button onclick="window.api.openFile('${r.path.replace(/'/g,"\\'")}')">é–‹ã</button>
                <button onclick="window.api.showInFinder('${r.path.replace(/'/g,"\\'")}')">Finder</button>
              </div>
            </div>
          `;
        });
        addMessage(html, 'ai');
        
      } catch (e) {
        loading.remove();
        addMessage(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'ai');
      }
    }
    
    $('chatSend').onclick = () => {
      doSearch($('chatInput').value);
      $('chatInput').value = '';
      $('chatInput').style.height = 'auto';
    };
    
    $('chatInput').onkeydown = e => {
      // IMEå…¥åŠ›ä¸­ã¯ç„¡è¦–
      if (e.isComposing || e.keyCode === 229) return;
      
      // Enter ã§é€ä¿¡ï¼ˆShift+Enterã¯æ”¹è¡Œï¼‰
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doSearch($('chatInput').value);
        $('chatInput').value = '';
        $('chatInput').style.height = 'auto';
      }
    };
    
    $('chatInput').oninput = () => {
      $('chatInput').style.height = 'auto';
      $('chatInput').style.height = Math.min($('chatInput').scrollHeight, 100) + 'px';
    };
    
    // ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«é–‹é–‰
    $('chatToggle').onclick = () => {
      $('chatPanel').classList.toggle('collapsed');
    };
    
    // åˆæœŸåŒ–
    async function init() {
      const data = await window.api.init();
      folderTree = data.folderTree;
      
      // ãƒ„ãƒªãƒ¼æç”»
      const treeContainer = $('folderTree');
      const items = Object.values(folderTree);
      renderTree(treeContainer, items);
      
      // æœ€åˆã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã
      if (items.length > 0) {
        navigateTo(items[0].path);
        treeContainer.querySelector('.tree-item')?.classList.add('active');
      }
    }
    
    init();
  </script>
</body>
</html>
